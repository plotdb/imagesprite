// Generated by LiveScript 1.6.0
(function(){
  var fs, fsExtra, path, jsdom, svgo, util, opt, getDim, handleSvg, buildSvg;
  fs = require('fs');
  fsExtra = require('fs-extra');
  path = require('path');
  jsdom = require('jsdom');
  svgo = require('svgo');
  util = require('./util');
  opt = {
    plugins: ["minifyStyles"]
  };
  jsdom = jsdom.JSDOM;
  getDim = function(svg){
    var document, viewBox, width, height;
    document = new jsdom(svg).window.document;
    svg = document.querySelector('svg');
    viewBox = (svg.getAttribute('viewBox') || '0 0 100 100').split(' ');
    width = +((svg.style.width || svg.getAttribute('width') || viewBox[2]) + "").replace(/[^0-9]+$/, '');
    height = +((svg.style.height || svg.getAttribute('height') || viewBox[3]) + "").replace(/[^0-9]+$/, '');
    return {
      width: width,
      height: height
    };
  };
  handleSvg = function(list){
    var promise;
    return promise = new Promise(function(res, rej){
      var sdim, code, coordinates, _;
      sdim = {
        width: 0,
        height: 0
      };
      code = [];
      coordinates = [];
      _ = function(list){
        var file, data;
        file = list.splice(0, 1)[0];
        if (!file) {
          return res({
            sdim: sdim,
            code: code,
            coordinates: coordinates
          });
        }
        data = fs.readFileSync(path.join(file.root, file.path)).toString();
        return Promise.resolve(svgo.optimize(data, opt)).then(function(it){
          var ref$, width, height, x, y, ret;
          ref$ = getDim(it.data), width = ref$.width, height = ref$.height;
          ref$ = [sdim.width, 0], x = ref$[0], y = ref$[1];
          if (height > sdim.height) {
            sdim.height = height;
          }
          ret = Buffer.from(it.data).toString('base64');
          code.push("<image x=\"" + x + "\" y=\"" + y + "\" width=\"" + width + "\" height=\"" + height + "\" xlink:href=\"data:image/svg+xml;base64," + ret + "\"/>");
          coordinates[file.path] = {
            x: x,
            y: y,
            width: width,
            height: height
          };
          sdim.width += width + 2;
          return _(list);
        });
      };
      return _(list);
    });
  };
  buildSvg = function(opt){
    var name, outdir, base, cwd, list;
    opt == null && (opt = {});
    name = opt.name || 'svg-sprite';
    outdir = opt.outdir;
    base = opt.base;
    cwd = process.cwd();
    if (opt.root.endsWith('/')) {
      opt.root.replace(/\/$/, '');
    }
    if (opt.files) {
      list = opt.files.filter(function(it){
        return it;
      }).map(function(it){
        var p;
        p = it.replace(opt.root, '');
        return {
          root: opt.root,
          path: p
        };
      });
    } else {
      util.recurse(opt.root, {
        rule: /\.svg$/
      }, list = []);
    }
    return handleSvg(list).then(function(arg$){
      var sdim, code, coordinates, ret, bkimg, css, k, idim, paddingTop, bksize, bkposX, bkposY, kn;
      sdim = arg$.sdim, code = arg$.code, coordinates = arg$.coordinates;
      ret = {};
      ret.image = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" preserveAspectRatio=\"none\" viewBox=\"0 0 " + sdim.width + " " + sdim.height + "\" width=\"" + sdim.width + "\" height=\"" + sdim.height + "\">\n" + code.join('\n') + "\n</svg>";
      bkimg = base && name ? "background-image: url(" + path.join(base, name + '.svg') + ");" : "";
      css = ["." + name + " {\n  display: inline-block;\n  position: relative;\n}\n." + name + ":before {\n  content: \" \";\n  width: 100%;\n  display: block;\n  " + bkimg + "\n}"];
      for (k in coordinates) {
        idim = coordinates[k];
        paddingTop = idim.height / idim.width * 100 + "%!important";
        bksize = sdim.width / idim.width * 100 + "%";
        bkposX = (idim.x / sdim.width) * (sdim.width / idim.width) / (sdim.width / idim.width - 1) * 100 + "%";
        bkposY = ((idim.y || 0) / sdim.height) * (sdim.height / idim.height) / (sdim.height / idim.height - 1 || 1) * 100 + "%";
        if (opt.prefix) {
          k = path.join(opt.prefix, k);
        }
        kn = (k + "").replace(/\.svg$/, '');
        css.push("." + name + "[data-name=\"" + kn + "\"] {\n  width: " + (idim.width + 1) + "px;\n}\n." + name + "[data-name=\"" + kn + "\"]:before {\n  background-size: " + bksize + ";\n  background-position: " + bkposX + " " + bkposY + ";\n  padding-top: " + paddingTop + "\n}");
      }
      ret.css = css.join('\n');
      ret.coord = coordinates;
      ret.dimension = sdim;
      if (outdir) {
        fsExtra.ensureDirSync(outdir);
        fs.writeFileSync(path.join(outdir, name + ".svg"), ret.image);
        fs.writeFileSync(path.join(outdir, name + ".css"), ret.css);
      }
      return ret;
    });
  };
  module.exports = buildSvg;
}).call(this);
